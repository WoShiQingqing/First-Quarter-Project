# syntax=docker/dockerfile:1

# ========== 构建阶段 ==========
FROM golang:1.22 AS build
WORKDIR /src

# 可选：QEMU/多架构编译三件套
ARG TARGETOS
ARG TARGETARCH
ENV GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} CGO_ENABLED=0

# 只拷贝 api 模块的 go.mod / go.sum，先拉依赖
COPY W2/cloudnative-jobflow/api/go.mod .
COPY W2/cloudnative-jobflow/api/go.sum .
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download

# 再拷贝 api 源码并编译
COPY W2/cloudnative-jobflow/api/ ./
RUN --mount=type=cache,target=/go/pkg/mod \
    go build -o /out/api .

# ========== 运行阶段 ==========
FROM gcr.io/distroless/static:nonroot
WORKDIR /app
COPY --from=build /out/api /app/api
USER nonroot:nonroot
ENTRYPOINT ["/app/api"]
