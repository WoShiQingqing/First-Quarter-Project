# syntax=docker/dockerfile:1.7

# 构建层
FROM golang:1.23 AS build

# 先切到 API 模块目录
WORKDIR /src/W2/cloudnative-jobflow/api

# 先只拷贝模块依赖文件，利用缓存
COPY W2/cloudnative-jobflow/api/go.mod .
COPY W2/cloudnative-jobflow/api/go.sum .

# 可选：设置 Go 代理，提升稳定性
ENV GOPROXY=https://proxy.golang.org,direct

# 缓存依赖目录，加速拉依赖
RUN --mount=type=cache,target=/go/pkg/mod \
    go mod download

# 再拷贝源码
COPY W2/cloudnative-jobflow/api/ .

# 编译
ARG TARGETOS TARGETARCH
RUN CGO_ENABLED=0 \
    GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} \
    go build -o /out/api

# 运行层
FROM gcr.io/distroless/static:nonroot
WORKDIR /app
COPY --from=build /out/api /app/api
USER nonroot:nonroot
ENTRYPOINT ["/app/api"]
